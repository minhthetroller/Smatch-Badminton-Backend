openapi: 3.1.0
info:
  title: Smatch Badminton Backend API
  description: |
    API for managing badminton court information, bookings, payments, and serving vector map tiles.
    
    ## Features
    - **Courts Management**: CRUD operations for badminton courts
    - **Search & Autocomplete**: Real-time search with Vietnamese support
    - **Availability**: Time slot availability with pricing
    - **Bookings**: Court reservation system
    - **Payments**: ZaloPay integration with real-time WebSocket notifications
    - **Map Tiles**: Vector tiles for interactive maps
    - **Exchange Matches**: Create and join badminton matches with other players
    
    ## Changelog
    ### v2.3.0 (2025-12-27)
    - Added `POST /api/matches/{id}/payment` for ZaloPay match join payments
    - Added `GET /api/matches/{id}/payment/{paymentId}/status` for payment status query
    - Added `PENDING_PAYMENT` and `EXPIRED` to MatchPlayerStatus enum
    - Added `MATCH_JOIN` payment type
    - Fixed null-safety on host serialization in match responses
    - Updated error responses to include machine-readable `code` field
    - Aligned SkillLevel enum: TBY, Y, Y_PLUS, Y_PLUS_PLUS, TBK, TB, TB_PLUS, TB_PLUS_PLUS, K, K_PLUS, GIOI
    - Aligned PlayerFormat enum: SINGLE_MALE, SINGLE_FEMALE, DOUBLE_MALE, DOUBLE_FEMALE, MIXED_DOUBLE, ANY
  version: 2.3.0
  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: http://localhost:3000
    description: Development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Auth
    description: User authentication and profile management (Firebase Auth)
  - name: Courts
    description: Court management operations
  - name: Search
    description: Search and autocomplete functionality
  - name: Availability
    description: Court availability and pricing
  - name: Bookings
    description: Booking management
  - name: Payments
    description: ZaloPay payment integration
  - name: Matches
    description: Exchange match creation and joining
  - name: Map Tiles
    description: Vector map tiles
  - name: Admin
    description: Administrative operations

security:
  - BearerAuth: []

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check if the server is running
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                    example: '2025-11-25T12:00:00.000Z'

  # ==================== Auth Endpoints ====================

  /api/auth/verify:
    post:
      tags:
        - Auth
      summary: Verify Firebase token
      description: |
        Verify Firebase ID token and create/get user.
        Used for all login types: Google, Facebook, Email/Password.
        Creates a new user if not exists, otherwise returns existing user.
      operationId: verifyToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyTokenRequest'
      responses:
        '200':
          description: User verified (existing user)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '201':
          description: User created (new user)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/anonymous:
    post:
      tags:
        - Auth
      summary: Create anonymous user
      description: |
        Create or get anonymous user session.
        Used for anonymous booking flow where users can book without registration.
      operationId: createAnonymous
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAnonymousRequest'
      responses:
        '200':
          description: Anonymous user retrieved (existing)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '201':
          description: Anonymous user created (new)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /api/auth/convert:
    post:
      tags:
        - Auth
      summary: Convert anonymous to registered
      description: |
        Convert anonymous user to registered user.
        Requires authenticated anonymous user.
        All existing bookings will be preserved and linked to the new account.
      operationId: convertAnonymous
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConvertAnonymousRequest'
      responses:
        '200':
          description: User converted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConvertResponse'
        '400':
          description: User is not anonymous or invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Email or username already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/me:
    get:
      tags:
        - Auth
      summary: Get current user profile
      description: Get the authenticated user's profile information
      operationId: getProfile
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Auth
      summary: Update user profile
      description: Update the authenticated user's profile information
      operationId: updateProfile
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Username already taken
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/me/bookings:
    get:
      tags:
        - Auth
      summary: Get user's booking history
      description: |
        Get paginated booking history for the authenticated user.
        Works for both anonymous and registered users.
      operationId: getBookingHistory
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Items per page
          schema:
            type: integer
            default: 10
            maximum: 50
        - name: status
          in: query
          description: Filter by booking status
          schema:
            type: string
            enum: [pending, confirmed, cancelled, completed]
      responses:
        '200':
          description: Booking history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookingHistoryResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/username/check:
    post:
      tags:
        - Auth
      summary: Check username availability
      description: Check if a username is available for registration
      operationId: checkUsername
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckUsernameRequest'
      responses:
        '200':
          description: Username availability status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsernameAvailabilityResponse'
        '400':
          description: Invalid username format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/username/lookup:
    post:
      tags:
        - Auth
      summary: Lookup email by username
      description: |
        Get the email associated with a username.
        Used in the login flow when user enters username instead of email.
      operationId: lookupUsername
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LookupUsernameRequest'
      responses:
        '200':
          description: Email found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsernameLookupResponse'
        '404':
          description: Username not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/link-bookings:
    post:
      tags:
        - Auth
      summary: Link existing bookings
      description: |
        Link existing bookings made as guest to the authenticated user.
        Matches by phone number or email.
      operationId: linkBookings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LinkBookingsRequest'
      responses:
        '200':
          description: Bookings linked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LinkBookingsResponse'
        '400':
          description: Phone number or email required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/account:
    delete:
      tags:
        - Auth
      summary: Delete user account
      description: |
        Delete the authenticated user's account.
        Requires a registered (non-anonymous) user.
        Existing bookings will have their user reference removed but won't be deleted.
      operationId: deleteAccount
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Account deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessageResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Anonymous users cannot delete accounts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==================== Court Endpoints ====================

  /api/courts:
    get:
      tags:
        - Courts
      summary: List all courts
      description: Get paginated list of all courts with optional filtering
      operationId: listCourts
      parameters:
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Items per page
          schema:
            type: integer
            default: 10
        - name: district
          in: query
          description: Filter by district name
          schema:
            type: string
      responses:
        '200':
          description: List of courts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourtListResponse'

    post:
      tags:
        - Courts
      summary: Create a new court
      description: Create a new badminton court
      operationId: createCourt
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCourtRequest'
      responses:
        '201':
          description: Court created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourtResponse'

  /api/courts/nearby:
    get:
      tags:
        - Courts
      summary: Find nearby courts
      description: Find courts within a specified radius from a location
      operationId: findNearbyCourts
      parameters:
        - name: latitude
          in: query
          required: true
          description: GPS latitude
          schema:
            type: number
            format: float
        - name: longitude
          in: query
          required: true
          description: GPS longitude
          schema:
            type: number
            format: float
        - name: radius
          in: query
          description: Search radius in km
          schema:
            type: number
            format: float
            default: 5
      responses:
        '200':
          description: List of nearby courts with distance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NearbyCourtListResponse'

  /api/courts/{id}:
    get:
      tags:
        - Courts
      summary: Get court by ID
      description: Get a specific court by its UUID
      operationId: getCourtById
      parameters:
        - name: id
          in: path
          required: true
          description: Court UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Court details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourtResponse'
        '404':
          description: Court not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Courts
      summary: Update a court
      description: Update an existing court
      operationId: updateCourt
      parameters:
        - name: id
          in: path
          required: true
          description: Court UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCourtRequest'
      responses:
        '200':
          description: Court updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourtResponse'
        '404':
          description: Court not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Courts
      summary: Delete a court
      description: Delete an existing court
      operationId: deleteCourt
      parameters:
        - name: id
          in: path
          required: true
          description: Court UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Court deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessageResponse'
        '404':
          description: Court not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/courts/{courtId}/availability:
    get:
      tags:
        - Availability
      summary: Get court availability
      description: Get availability for all sub-courts of a court on a specific date
      operationId: getCourtAvailability
      parameters:
        - name: courtId
          in: path
          required: true
          description: Court UUID
          schema:
            type: string
            format: uuid
        - name: date
          in: query
          required: true
          description: Date in YYYY-MM-DD format
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Court availability
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvailabilityResponse'
        '404':
          description: Court not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/search/autocomplete:
    get:
      tags:
        - Search
      summary: Autocomplete suggestions
      description: |
        Get real-time autocomplete suggestions from Redis.
        Supports Vietnamese diacritics - searches both accented and unaccented text.
        Example: "cau giay" will match "Cầu Giấy"
        
        Use `includeDetails=true` to include address and geolocation coordinates in the response.
      operationId: searchAutocomplete
      parameters:
        - name: q
          in: query
          required: true
          description: Search prefix (minimum 2 characters)
          schema:
            type: string
            minLength: 2
        - name: limit
          in: query
          description: Maximum results
          schema:
            type: integer
            default: 10
            maximum: 20
        - name: includeDetails
          in: query
          description: Include address and geolocation in response
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Autocomplete suggestions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AutocompleteResponse'
              examples:
                basic:
                  summary: Basic response (default)
                  value:
                    success: true
                    data:
                      suggestions:
                        - id: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
                          text: "Sân Cầu Lông Ngọc Khánh"
                          score: 100
                withDetails:
                  summary: Response with details (includeDetails=true)
                  value:
                    success: true
                    data:
                      suggestions:
                        - id: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
                          text: "Sân Cầu Lông Ngọc Khánh"
                          score: 100
                          address: "123 Ngọc Khánh, Phường Ngọc Khánh, Quận Ba Đình, Hà Nội"
                          latitude: 21.0285
                          longitude: 105.8542
        '400':
          description: Invalid query
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/search/courts:
    get:
      tags:
        - Search
      summary: Full fuzzy search
      description: |
        Full fuzzy search using PostgreSQL pg_trgm.
        Supports typo-tolerance and Vietnamese diacritics-insensitive search.
      operationId: searchCourts
      parameters:
        - name: q
          in: query
          required: true
          description: Search query (minimum 2 characters)
          schema:
            type: string
            minLength: 2
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Items per page
          schema:
            type: integer
            default: 10
            maximum: 50
        - name: minSimilarity
          in: query
          description: Minimum similarity threshold (0-1)
          schema:
            type: number
            format: float
            default: 0.3
            minimum: 0
            maximum: 1
        - name: district
          in: query
          description: Filter by district name
          schema:
            type: string
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchCourtListResponse'
        '400':
          description: Invalid query
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/search/popular:
    get:
      tags:
        - Search
      summary: Get popular searches
      description: Get trending/popular search queries
      operationId: getPopularSearches
      parameters:
        - name: limit
          in: query
          description: Number of results
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Popular searches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PopularSearchesResponse'

  /api/admin/search/reindex:
    post:
      tags:
        - Admin
      summary: Rebuild search index
      description: Rebuild the Redis autocomplete index from the database
      operationId: reindexSearch
      responses:
        '200':
          description: Index rebuilt successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReindexResponse'

  /api/admin/search/stats:
    get:
      tags:
        - Admin
      summary: Get search index statistics
      description: Get statistics about the search index
      operationId: getSearchStats
      responses:
        '200':
          description: Search index statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchStatsResponse'

  /api/bookings:
    get:
      tags:
        - Bookings
      summary: Get bookings by phone
      description: Get all bookings for a phone number
      operationId: getBookingsByPhone
      security: []
      parameters:
        - name: phone
          in: query
          required: true
          description: Phone number
          schema:
            type: string
      responses:
        '200':
          description: List of bookings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookingListResponse'

    post:
      tags:
        - Bookings
      summary: Create a booking
      description: |
        Create a new court booking. Minimum duration is 1 hour, in 30-minute increments.
        
        **Authentication Required**: Requires an authenticated Firebase user (registered or anonymous).
        The `userId` is automatically extracted from the Bearer token and should NOT be provided in the request body.
        
        **Single vs Group Bookings**:
        - **Single booking**: Provide `subCourtId`, `date`, `startTime`, `endTime` directly in the request body.
          Response will be a single booking object.
        - **Group booking**: Provide an array of bookings via the `bookings` field.
          Response will be an array of booking objects.
        
        **Time Validation**:
        - Start time must be before end time
        - Minimum duration: 1 hour (60 minutes)
        - Time increments: 30-minute slots only
        - Format: "HH:mm" (24-hour format)
        
        **Date Format**: "YYYY-MM-DD"
      operationId: createBooking
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBookingRequest'
            examples:
              singleBooking:
                summary: Single booking example
                value:
                  subCourtId: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
                  date: "2025-12-15"
                  startTime: "14:00"
                  endTime: "16:00"
                  guestName: "Nguyễn Văn A"
                  guestPhone: "0912345678"
                  guestEmail: "nguyen.van.a@example.com"
                  notes: "Prefer court near entrance"
              groupBooking:
                summary: Group booking (multiple courts/times)
                value:
                  bookings:
                    - subCourtId: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
                      date: "2025-12-15"
                      startTime: "14:00"
                      endTime: "16:00"
                    - subCourtId: "b1ffc99-9c0b-4ef8-bb6d-6bb9bd380a22"
                      date: "2025-12-15"
                      startTime: "14:00"
                      endTime: "16:00"
                  guestName: "Nguyễn Văn A"
                  guestPhone: "0912345678"
                  guestEmail: "nguyen.van.a@example.com"
                  notes: "Tournament booking"
      responses:
        '201':
          description: Booking created successfully
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/BookingResponse'
                  - $ref: '#/components/schemas/BookingListResponse'
              examples:
                singleBookingResponse:
                  summary: Single booking response
                  value:
                    success: true
                    data:
                      id: "c2ddc99-9c0b-4ef8-bb6d-6bb9bd380a33"
                      subCourtId: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
                      subCourtName: "Sân 1"
                      courtId: "d3eec99-9c0b-4ef8-bb6d-6bb9bd380a44"
                      courtName: "Sân Cầu Lông Ngọc Khánh"
                      guestName: "Nguyễn Văn A"
                      guestPhone: "0912345678"
                      guestEmail: "nguyen.van.a@example.com"
                      date: "2025-12-15"
                      startTime: "14:00"
                      endTime: "16:00"
                      totalPrice: 200000
                      status: "pending"
                      notes: "Prefer court near entrance"
                      createdAt: "2025-12-10T10:30:00.000Z"
                groupBookingResponse:
                  summary: Group booking response
                  value:
                    success: true
                    data:
                      - id: "c2ddc99-9c0b-4ef8-bb6d-6bb9bd380a33"
                        subCourtId: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
                        subCourtName: "Sân 1"
                        courtId: "d3eec99-9c0b-4ef8-bb6d-6bb9bd380a44"
                        courtName: "Sân Cầu Lông Ngọc Khánh"
                        guestName: "Nguyễn Văn A"
                        guestPhone: "0912345678"
                        guestEmail: "nguyen.van.a@example.com"
                        date: "2025-12-15"
                        startTime: "14:00"
                        endTime: "16:00"
                        totalPrice: 200000
                        status: "pending"
                        notes: "Tournament booking"
                        createdAt: "2025-12-10T10:30:00.000Z"
                      - id: "e4ffc99-9c0b-4ef8-bb6d-6bb9bd380a55"
                        subCourtId: "b1ffc99-9c0b-4ef8-bb6d-6bb9bd380a22"
                        subCourtName: "Sân 2"
                        courtId: "d3eec99-9c0b-4ef8-bb6d-6bb9bd380a44"
                        courtName: "Sân Cầu Lông Ngọc Khánh"
                        guestName: "Nguyễn Văn A"
                        guestPhone: "0912345678"
                        guestEmail: "nguyen.van.a@example.com"
                        date: "2025-12-15"
                        startTime: "14:00"
                        endTime: "16:00"
                        totalPrice: 200000
                        status: "pending"
                        notes: "Tournament booking"
                        createdAt: "2025-12-10T10:30:00.000Z"
        '400':
          description: Invalid request (bad format, invalid time range, duration less than 1 hour, or not 30-minute increments)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidDate:
                  summary: Invalid date format
                  value:
                    success: false
                    error:
                      message: "Invalid date format for 2025-15-12. Use YYYY-MM-DD"
                shortDuration:
                  summary: Duration less than 1 hour
                  value:
                    success: false
                    error:
                      message: "Minimum booking duration is 1 hour"
                invalidIncrement:
                  summary: Not 30-minute increment
                  value:
                    success: false
                    error:
                      message: "Booking duration must be in 30-minute increments"
                invalidTimeRange:
                  summary: Start time after end time
                  value:
                    success: false
                    error:
                      message: "Start time must be before end time for 16:00-14:00"
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  message: "Authentication required"
        '404':
          description: Sub-court not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  message: "Sub-court a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11 not found"
        '409':
          description: Time slot already booked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  message: "Time slot 14:00-16:00 for Sân 1 is already booked"

  /api/bookings/{id}:
    get:
      tags:
        - Bookings
      summary: Get booking by ID
      description: Get a specific booking by its UUID
      operationId: getBookingById
      parameters:
        - name: id
          in: path
          required: true
          description: Booking UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Booking details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookingResponse'
        '404':
          description: Booking not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Bookings
      summary: Cancel a booking
      description: Cancel an existing booking
      operationId: cancelBooking
      parameters:
        - name: id
          in: path
          required: true
          description: Booking UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Booking cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookingResponse'
        '400':
          description: Booking already cancelled or completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Booking not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/bookings/{bookingId}/payment:
    get:
      tags:
        - Bookings
      summary: Get payment for booking
      description: Get payment information for a specific booking
      operationId: getBookingPayment
      parameters:
        - name: bookingId
          in: path
          required: true
          description: Booking UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'
        '404':
          description: Booking or payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/payments/create:
    post:
      tags:
        - Payments
      summary: Create a payment
      description: |
        Create a ZaloPay payment order for a booking.
        Returns QR code image and WebSocket URL for real-time notifications.
        The time slot is locked in Redis for 10 minutes.
      operationId: createPayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
      responses:
        '201':
          description: Payment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePaymentResponse'
        '400':
          description: Invalid booking status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Booking not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Time slot is being reserved by another user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/payments/callback:
    post:
      tags:
        - Payments
      summary: ZaloPay callback (webhook)
      description: |
        Webhook endpoint called by ZaloPay after payment completion.
        **Do not call this endpoint directly.**
      operationId: paymentCallback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ZaloPayCallbackRequest'
      responses:
        '200':
          description: Callback processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZaloPayCallbackResponse'

  /api/payments/{id}:
    get:
      tags:
        - Payments
      summary: Get payment by ID
      description: Get payment details with associated booking information
      operationId: getPaymentById
      parameters:
        - name: id
          in: path
          required: true
          description: Payment UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentWithBookingResponse'
        '404':
          description: Payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/payments/{id}/status:
    get:
      tags:
        - Payments
      summary: Query payment status
      description: Query the latest payment status from ZaloPay and sync with local database
      operationId: queryPaymentStatus
      parameters:
        - name: id
          in: path
          required: true
          description: Payment UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Payment status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'
        '404':
          description: Payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/map-tiles/{z}/{x}/{y}.pbf:
    get:
      tags:
        - Map Tiles
      summary: Get vector tile
      description: Get a vector tile (MVT format) for rendering courts on a map
      operationId: getVectorTile
      parameters:
        - name: z
          in: path
          required: true
          description: Zoom level (0-22)
          schema:
            type: integer
            minimum: 0
            maximum: 22
        - name: x
          in: path
          required: true
          description: Tile X coordinate
          schema:
            type: integer
        - name: y
          in: path
          required: true
          description: Tile Y coordinate
          schema:
            type: integer
      responses:
        '200':
          description: Vector tile data
          content:
            application/vnd.mapbox-vector-tile:
              schema:
                type: string
                format: binary
        '502':
          description: Tile server unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==================== Match (Exchange) Endpoints ====================

  /api/matches:
    get:
      tags:
        - Matches
      summary: List exchange matches
      description: |
        Get paginated list of exchange matches with optional filters.
        Use this to discover matches looking for players.
      operationId: listMatches
      security: []
      parameters:
        - name: courtId
          in: query
          description: Filter by court UUID
          schema:
            type: string
            format: uuid
        - name: skillLevel
          in: query
          description: Filter by skill level
          schema:
            $ref: '#/components/schemas/SkillLevel'
        - name: playerFormat
          in: query
          description: Filter by player format
          schema:
            $ref: '#/components/schemas/PlayerFormat'
        - name: status
          in: query
          description: Filter by match status
          schema:
            $ref: '#/components/schemas/MatchStatus'
        - name: date
          in: query
          description: Filter by specific date (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: dateFrom
          in: query
          description: Filter matches from this date
          schema:
            type: string
            format: date
        - name: dateTo
          in: query
          description: Filter matches until this date
          schema:
            type: string
            format: date
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Items per page (max 50)
          schema:
            type: integer
            default: 10
            maximum: 50
      responses:
        '200':
          description: List of matches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchListResponse'

    post:
      tags:
        - Matches
      summary: Create an exchange match
      description: |
        Create a new exchange match to find players.
        
        **Authentication Required**: Requires a registered (non-anonymous) user.
        
        **Images**: Provide S3 URLs for match images. Frontend should upload to S3 first.
        
        **Privacy**: 
        - Public matches (isPrivate: false): Players join immediately
        - Private matches (isPrivate: true): Host must approve join requests
      operationId: createMatch
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMatchRequest'
            examples:
              publicMatch:
                summary: Public match example
                value:
                  courtId: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
                  title: "Đánh giao lưu cuối tuần"
                  description: "Tìm bạn đánh giao lưu level TB+"
                  skillLevel: "TB_PLUS"
                  shuttleType: "TC77"
                  playerFormat: "DOUBLE_MALE"
                  date: "2025-12-28"
                  startTime: "18:00"
                  endTime: "20:00"
                  isPrivate: false
                  price: 50000
                  slotsNeeded: 3
              privateMatch:
                summary: Private match with approval
                value:
                  courtId: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
                  title: "Tập luyện nghiêm túc"
                  skillLevel: "K"
                  shuttleType: "YONEX_AS40"
                  playerFormat: "MIXED_DOUBLE"
                  date: "2025-12-29"
                  startTime: "19:00"
                  endTime: "21:00"
                  isPrivate: true
                  price: 75000
                  slotsNeeded: 2
      responses:
        '201':
          description: Match created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Court not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/matches/hosted:
    get:
      tags:
        - Matches
      summary: Get matches hosted by current user
      description: Get all matches created by the authenticated user
      operationId: getHostedMatches
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by match status
          schema:
            $ref: '#/components/schemas/MatchStatus'
      responses:
        '200':
          description: List of hosted matches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchWithPlayersListResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/matches/joined:
    get:
      tags:
        - Matches
      summary: Get matches joined by current user
      description: Get all matches the authenticated user has joined or requested to join
      operationId: getJoinedMatches
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of joined matches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchWithPlayersListResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/matches/{id}:
    get:
      tags:
        - Matches
      summary: Get match by ID
      description: Get detailed match information including all players
      operationId: getMatchById
      security: []
      parameters:
        - name: id
          in: path
          required: true
          description: Match UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Match details with players
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchWithPlayersResponse'
        '404':
          description: Match not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Matches
      summary: Update a match
      description: Update match details. Only the host can update.
      operationId: updateMatch
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Match UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMatchRequest'
      responses:
        '200':
          description: Match updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized (not the host)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Match not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Matches
      summary: Cancel a match
      description: Cancel a match. Only the host can cancel. All players will be notified.
      operationId: cancelMatch
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Match UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Match cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessageResponse'
        '400':
          description: Cannot cancel (already completed or cancelled)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized (not the host)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Match not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/matches/{id}/join:
    post:
      tags:
        - Matches
      summary: Join a match
      description: |
        Request to join a match.
        
        **Public matches**: Player is immediately accepted (if slots available)
        **Private matches**: Request is pending until host approves
        
        WebSocket notifications are sent to the host for new requests.
      operationId: joinMatch
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Match UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinMatchRequest'
            examples:
              withMessage:
                summary: Join with message to host
                value:
                  message: "Mình level TB+, đánh được đôi nam. Có thể đến sớm 15 phút."
              noMessage:
                summary: Join without message
                value: {}
      responses:
        '201':
          description: Join request created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchPlayerResponse'
        '400':
          description: Invalid request (match not open, host cannot join own match)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Match not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Already requested or match is full
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/matches/{id}/leave:
    delete:
      tags:
        - Matches
      summary: Leave a match
      description: Leave a match you have joined. The match will reopen if it was full.
      operationId: leaveMatch
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Match UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Left match successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessageResponse'
        '400':
          description: Not a participant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Match not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/matches/{id}/requests/{playerId}/respond:
    post:
      tags:
        - Matches
      summary: Respond to join request
      description: |
        Accept or reject a player's join request (host only, for private matches).
        
        WebSocket notification is sent to the player with the result.
      operationId: respondToJoinRequest
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Match UUID
          schema:
            type: string
            format: uuid
        - name: playerId
          in: path
          required: true
          description: MatchPlayer UUID (from join request)
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RespondToJoinRequest'
            examples:
              accept:
                summary: Accept player
                value:
                  status: "ACCEPTED"
              reject:
                summary: Reject player
                value:
                  status: "REJECTED"
      responses:
        '200':
          description: Response recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchPlayerResponse'
        '400':
          description: Invalid request (already responded, match full)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized (not the host)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Match or player request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/matches/{id}/payment:
    post:
      tags:
        - Matches
      summary: Create payment for joining a match
      description: |
        Create a ZaloPay payment for joining a match (100% upfront fee).
        
        **Flow:**
        1. Validates match exists and is open for joining
        2. Creates a MatchPlayer with PENDING_PAYMENT status
        3. Creates ZaloPay order with match price (100% upfront)
        4. Returns payment details with QR code for scanning
        5. After payment success, player status changes to ACCEPTED
        
        **Notes:**
        - Amount is automatically set to match price (cannot be overridden)
        - Free matches (price = 0) should use POST /api/matches/{id}/join directly
        - Private matches require host approval first
        - Payment expires after configured timeout (default 15 minutes)
        
        **WebSocket:** Subscribe to payment status updates at the returned wsSubscribeUrl
      operationId: createMatchJoinPayment
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Match UUID
          schema:
            type: string
            format: uuid
      responses:
        '201':
          description: Payment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchPaymentResponse'
        '400':
          description: |
            Bad request:
            - Match is not open
            - User is the host
            - Match is free (use join endpoint)
            - Private match requires approval first
            - Match is full
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Match not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Already joined or has pending request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/matches/{id}/payment/{paymentId}/status:
    get:
      tags:
        - Matches
      summary: Query match payment status
      description: |
        Query the current status of a match join payment from ZaloPay.
        Updates local record if status changed.
      operationId: queryMatchPaymentStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Match UUID
          schema:
            type: string
            format: uuid
        - name: paymentId
          in: path
          required: true
          description: Payment UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Payment status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentStatusResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    # Common Response Schemas
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            message:
              type: string
              example: Error description
            code:
              type: string
              description: Machine-readable error code for programmatic handling
              example: TOKEN_EXPIRED

    SuccessMessageResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                message:
                  type: string

    PaginationMeta:
      type: object
      properties:
        pagination:
          type: object
          properties:
            page:
              type: integer
            limit:
              type: integer
            total:
              type: integer
            totalPages:
              type: integer
            hasNext:
              type: boolean
            hasPrev:
              type: boolean

    # Court Schemas
    Court:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        phoneNumbers:
          type: array
          items:
            type: string
        addressStreet:
          type: string
          nullable: true
        addressWard:
          type: string
          nullable: true
        addressDistrict:
          type: string
          nullable: true
        addressCity:
          type: string
          default: Hà Nội
        details:
          $ref: '#/components/schemas/CourtDetails'
        openingHours:
          $ref: '#/components/schemas/OpeningHours'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CourtDetails:
      type: object
      properties:
        amenities:
          type: array
          items:
            type: string
        payments:
          type: array
          items:
            type: string
        serviceOptions:
          type: array
          items:
            type: string
        highlights:
          type: array
          items:
            type: string

    OpeningHours:
      type: object
      properties:
        mon:
          type: string
          example: '06:00-22:00'
        tue:
          type: string
        wed:
          type: string
        thu:
          type: string
        fri:
          type: string
        sat:
          type: string
        sun:
          type: string

    CourtLocation:
      type: object
      properties:
        latitude:
          type: number
          format: float
        longitude:
          type: number
          format: float

    CreateCourtRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string
        phoneNumbers:
          type: array
          items:
            type: string
        addressStreet:
          type: string
        addressWard:
          type: string
        addressDistrict:
          type: string
        addressCity:
          type: string
        details:
          $ref: '#/components/schemas/CourtDetails'
        openingHours:
          $ref: '#/components/schemas/OpeningHours'
        location:
          $ref: '#/components/schemas/CourtLocation'

    UpdateCourtRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        phoneNumbers:
          type: array
          items:
            type: string
        addressStreet:
          type: string
        addressWard:
          type: string
        addressDistrict:
          type: string
        addressCity:
          type: string
        details:
          $ref: '#/components/schemas/CourtDetails'
        openingHours:
          $ref: '#/components/schemas/OpeningHours'
        location:
          $ref: '#/components/schemas/CourtLocation'

    CourtResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/Court'

    CourtListResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Court'
            meta:
              $ref: '#/components/schemas/PaginationMeta'

    NearbyCourtListResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                allOf:
                  - $ref: '#/components/schemas/Court'
                  - type: object
                    properties:
                      distance:
                        type: number
                        format: float
                        description: Distance in meters

    # Search Schemas
    AutocompleteSuggestion:
      type: object
      required:
        - id
        - text
        - score
      properties:
        id:
          type: string
          format: uuid
          description: Court UUID
        text:
          type: string
          description: Court name
        score:
          type: number
          description: Relevance score
        address:
          type: string
          description: Combined address (only when includeDetails=true)
          example: "123 Ngọc Khánh, Phường Ngọc Khánh, Quận Ba Đình, Hà Nội"
        latitude:
          type: number
          format: double
          description: Latitude coordinate (only when includeDetails=true)
          example: 21.0285
        longitude:
          type: number
          format: double
          description: Longitude coordinate (only when includeDetails=true)
          example: 105.8542

    AutocompleteResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                suggestions:
                  type: array
                  items:
                    $ref: '#/components/schemas/AutocompleteSuggestion'

    SearchCourtResult:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        addressDistrict:
          type: string
          nullable: true
        addressCity:
          type: string
          nullable: true
        addressWard:
          type: string
          nullable: true
        addressStreet:
          type: string
          nullable: true
        nameScore:
          type: number
          format: float
          description: Similarity score for name match (0-1)
        districtScore:
          type: number
          format: float
          description: Similarity score for district match (0-1)

    SearchCourtListResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/SearchCourtResult'
            meta:
              $ref: '#/components/schemas/PaginationMeta'

    PopularSearchesResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                searches:
                  type: array
                  items:
                    type: string

    ReindexResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                message:
                  type: string
                indexed:
                  type: integer
                durationMs:
                  type: integer

    SearchStatsResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                autocompleteCount:
                  type: integer
                courtsCount:
                  type: integer

    # Availability Schemas
    TimeSlot:
      type: object
      properties:
        startTime:
          type: string
          example: '06:00'
        endTime:
          type: string
          example: '06:30'
        isAvailable:
          type: boolean
        price:
          type: integer
          description: Price in VND for the 30-minute slot

    SubCourtAvailability:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        isActive:
          type: boolean
        slots:
          type: array
          items:
            $ref: '#/components/schemas/TimeSlot'

    AvailabilityData:
      type: object
      properties:
        courtId:
          type: string
          format: uuid
        courtName:
          type: string
        date:
          type: string
          format: date
        dayType:
          type: string
          enum: [weekday, weekend, holiday]
        openingTime:
          type: string
        closingTime:
          type: string
        subCourts:
          type: array
          items:
            $ref: '#/components/schemas/SubCourtAvailability'

    AvailabilityResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/AvailabilityData'

    # Booking Schemas
    BookingItem:
      type: object
      required:
        - subCourtId
        - date
        - startTime
        - endTime
      properties:
        subCourtId:
          type: string
          format: uuid
          description: The sub-court to book
        date:
          type: string
          format: date
          description: Booking date in YYYY-MM-DD format
          example: '2025-12-15'
        startTime:
          type: string
          pattern: '^([01]\d|2[0-3]):[0-5]\d$'
          description: Start time in HH:mm format (24-hour)
          example: '10:00'
        endTime:
          type: string
          pattern: '^([01]\d|2[0-3]):[0-5]\d$'
          description: End time in HH:mm format (24-hour). Must be at least 1 hour after startTime, in 30-minute increments.
          example: '12:00'

    CreateSingleBookingRequest:
      type: object
      required:
        - subCourtId
        - date
        - startTime
        - endTime
        - guestName
        - guestPhone
      properties:
        subCourtId:
          type: string
          format: uuid
          description: The sub-court to book
        date:
          type: string
          format: date
          description: Booking date in YYYY-MM-DD format
          example: '2025-12-15'
        startTime:
          type: string
          pattern: '^([01]\d|2[0-3]):[0-5]\d$'
          description: Start time in HH:mm format (24-hour)
          example: '10:00'
        endTime:
          type: string
          pattern: '^([01]\d|2[0-3]):[0-5]\d$'
          description: End time in HH:mm format (24-hour). Must be at least 1 hour after startTime, in 30-minute increments.
          example: '12:00'
        guestName:
          type: string
          description: Full name of the person making the booking
          example: 'Nguyễn Văn A'
        guestPhone:
          type: string
          description: Contact phone number
          example: '0912345678'
        guestEmail:
          type: string
          format: email
          description: Optional email address
          example: 'nguyen.van.a@example.com'
        notes:
          type: string
          description: Optional booking notes or special requests
          example: 'Prefer court near entrance'

    CreateGroupBookingRequest:
      type: object
      required:
        - bookings
        - guestName
        - guestPhone
      properties:
        bookings:
          type: array
          minItems: 1
          description: Array of bookings to create (for multiple courts or time slots)
          items:
            $ref: '#/components/schemas/BookingItem'
        guestName:
          type: string
          description: Full name of the person making the bookings
          example: 'Nguyễn Văn A'
        guestPhone:
          type: string
          description: Contact phone number
          example: '0912345678'
        guestEmail:
          type: string
          format: email
          description: Optional email address
          example: 'nguyen.van.a@example.com'
        notes:
          type: string
          description: Optional booking notes or special requests
          example: 'Tournament booking for group event'

    CreateBookingRequest:
      description: |
        Request body for creating a booking. Can be either a single booking or group booking.
        
        **Important**: Do NOT include `userId` in the request body. It is automatically extracted 
        from the Firebase authentication token (Bearer token) in the Authorization header.
      oneOf:
        - $ref: '#/components/schemas/CreateSingleBookingRequest'
        - $ref: '#/components/schemas/CreateGroupBookingRequest'

    Booking:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Booking UUID
        subCourtId:
          type: string
          format: uuid
          description: Sub-court UUID
        subCourtName:
          type: string
          description: Name of the sub-court (e.g., "Sân 1")
        courtId:
          type: string
          format: uuid
          description: Parent court UUID
        courtName:
          type: string
          description: Name of the main court
        guestName:
          type: string
          description: Name of the person who made the booking
        guestPhone:
          type: string
          description: Contact phone number
        guestEmail:
          type: string
          nullable: true
          description: Contact email (optional)
        date:
          type: string
          format: date
          description: Booking date in YYYY-MM-DD format
        startTime:
          type: string
          description: Start time in HH:mm format
          example: '10:00'
        endTime:
          type: string
          description: End time in HH:mm format
          example: '12:00'
        totalPrice:
          type: integer
          description: Total price in VND (Vietnamese Dong)
          example: 200000
        status:
          type: string
          enum: [pending, confirmed, cancelled, completed]
          description: |
            Booking status:
            - `pending`: Booking created but payment not completed
            - `confirmed`: Payment successful, booking confirmed
            - `cancelled`: Booking cancelled
            - `completed`: Booking finished (past end time)
        notes:
          type: string
          nullable: true
          description: Optional booking notes
        createdAt:
          type: string
          format: date-time
          description: Timestamp when booking was created

    BookingResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/Booking'

    BookingListResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Booking'

    # Payment Schemas
    CreatePaymentRequest:
      type: object
      required:
        - bookingId
      properties:
        bookingId:
          type: string
          format: uuid

    Payment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        bookingId:
          type: string
          format: uuid
        appTransId:
          type: string
          description: ZaloPay transaction ID (format yymmdd_xxx)
        zpTransId:
          type: string
          nullable: true
          description: ZaloPay's internal transaction ID
        amount:
          type: integer
          description: Amount in VND
        status:
          type: string
          enum: [pending, success, failed, expired]
        orderUrl:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    QRCode:
      type: object
      properties:
        base64:
          type: string
          description: Full data URL for HTML img src
        rawBase64:
          type: string
          description: Raw base64 for Flutter Image.memory()

    CreatePaymentResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                payment:
                  $ref: '#/components/schemas/Payment'
                orderUrl:
                  type: string
                qrCode:
                  $ref: '#/components/schemas/QRCode'
                zpTransToken:
                  type: string
                  description: Token for ZaloPay SDK
                expireAt:
                  type: string
                  format: date-time
                  description: When slot lock expires
                wsSubscribeUrl:
                  type: string
                  description: WebSocket URL for real-time notifications

    PaymentResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/Payment'

    PaymentWithBookingResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              allOf:
                - $ref: '#/components/schemas/Payment'
                - type: object
                  properties:
                    booking:
                      $ref: '#/components/schemas/Booking'

    ZaloPayCallbackRequest:
      type: object
      properties:
        data:
          type: string
          description: JSON string with payment data
        mac:
          type: string
          description: HMAC signature
        type:
          type: integer
          description: 1 = payment success

    ZaloPayCallbackResponse:
      type: object
      properties:
        return_code:
          type: integer
        return_message:
          type: string

    # ==================== Auth Schemas ====================

    VerifyTokenRequest:
      type: object
      required:
        - idToken
      properties:
        idToken:
          type: string
          description: Firebase ID token
        profile:
          $ref: '#/components/schemas/UpdateProfileRequest'

    CreateAnonymousRequest:
      type: object
      required:
        - firebaseUid
      properties:
        firebaseUid:
          type: string
          description: Firebase anonymous UID from client

    ConvertAnonymousRequest:
      type: object
      required:
        - provider
      properties:
        newFirebaseUid:
          type: string
          description: New Firebase UID after linking/upgrading account
        provider:
          type: string
          enum: [google, facebook, password]
          description: Provider used for upgrade
        email:
          type: string
          format: email
          description: Email (required for password provider)
        username:
          type: string
          description: Optional username (3-50 chars, letters, numbers, underscores)
        profile:
          $ref: '#/components/schemas/UpdateProfileRequest'

    UpdateProfileRequest:
      type: object
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
          pattern: '^[a-zA-Z0-9_]+$'
          description: Username (3-50 chars, letters, numbers, underscores only)
        firstName:
          type: string
          maxLength: 100
        lastName:
          type: string
          maxLength: 100
        gender:
          type: string
          enum: [male, female, other, prefer_not_to_say]
        phoneNumber:
          type: string
          maxLength: 20
        photoUrl:
          type: string
          format: uri
        addressStreet:
          type: string
          maxLength: 255
        addressWard:
          type: string
          maxLength: 100
        addressDistrict:
          type: string
          maxLength: 100
        addressCity:
          type: string
          maxLength: 100
          default: Hà Nội

    CheckUsernameRequest:
      type: object
      required:
        - username
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50

    LookupUsernameRequest:
      type: object
      required:
        - username
      properties:
        username:
          type: string

    LinkBookingsRequest:
      type: object
      properties:
        phoneNumber:
          type: string
          description: Phone number to match bookings
        email:
          type: string
          format: email
          description: Email to match bookings

    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        firebaseUid:
          type: string
        email:
          type: string
          nullable: true
        username:
          type: string
          nullable: true
        provider:
          type: string
          enum: [google, facebook, password, anonymous]
        isAnonymous:
          type: boolean
        firstName:
          type: string
          nullable: true
        lastName:
          type: string
          nullable: true
        gender:
          type: string
          enum: [male, female, other, prefer_not_to_say]
          nullable: true
        phoneNumber:
          type: string
          nullable: true
        photoUrl:
          type: string
          nullable: true
        address:
          $ref: '#/components/schemas/UserAddress'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserAddress:
      type: object
      nullable: true
      properties:
        street:
          type: string
          nullable: true
        ward:
          type: string
          nullable: true
        district:
          type: string
          nullable: true
        city:
          type: string
          nullable: true

    AuthResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                user:
                  $ref: '#/components/schemas/UserProfile'
                isNewUser:
                  type: boolean

    ConvertResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                user:
                  $ref: '#/components/schemas/UserProfile'
                converted:
                  type: boolean

    UserProfileResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                user:
                  $ref: '#/components/schemas/UserProfile'

    UsernameAvailabilityResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                username:
                  type: string
                available:
                  type: boolean

    UsernameLookupResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                username:
                  type: string
                email:
                  type: string

    LinkBookingsResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                linkedCount:
                  type: integer
                message:
                  type: string

    BookingHistoryItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        date:
          type: string
          format: date
        startTime:
          type: string
          example: '10:00'
        endTime:
          type: string
          example: '12:00'
        totalPrice:
          type: integer
          description: Price in VND
        status:
          type: string
          enum: [pending, confirmed, cancelled, completed]
        notes:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        court:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            addressDistrict:
              type: string
              nullable: true
            addressCity:
              type: string
              nullable: true
        subCourt:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string

    BookingHistoryResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                bookings:
                  type: array
                  items:
                    $ref: '#/components/schemas/BookingHistoryItem'
                pagination:
                  type: object
                  properties:
                    page:
                      type: integer
                    limit:
                      type: integer
                    total:
                      type: integer
                    totalPages:
                      type: integer

    # ==================
    # Match Schemas
    # ==================
    
    SkillLevel:
      type: string
      description: |
        Player skill level (Vietnamese badminton skill tiers).
        Values: TBY (Trung bình yếu - Beginner), Y (Yếu - Weak), Y_PLUS (Yếu+), Y_PLUS_PLUS (Yếu++),
        TBK (Trung bình khá), TB (Trung bình - Average), TB_PLUS (Trung bình+), TB_PLUS_PLUS (Trung bình++),
        K (Khá - Good), K_PLUS (Khá+), GIOI (Giỏi - Excellent)
      enum:
        - TBY
        - Y
        - Y_PLUS
        - Y_PLUS_PLUS
        - TBK
        - TB
        - TB_PLUS
        - TB_PLUS_PLUS
        - K
        - K_PLUS
        - GIOI

    ShuttleType:
      type: string
      description: Type of shuttlecock
      enum:
        - TC77
        - BASAO
        - YONEX_AS30
        - YONEX_AS40
        - YONEX_AS50
        - VICTOR_MASTER_1
        - VICTOR_CHAMPION_1
        - RSL_CLASSIC
        - LINDAN_40
        - LINDAN_50
        - OTHER

    PlayerFormat:
      type: string
      description: Player format for the match
      enum:
        - SINGLE_MALE
        - SINGLE_FEMALE
        - DOUBLE_MALE
        - DOUBLE_FEMALE
        - MIXED_DOUBLE
        - ANY

    MatchStatus:
      type: string
      description: Match status
      enum:
        - OPEN
        - FULL
        - IN_PROGRESS
        - COMPLETED
        - CANCELLED

    MatchPlayerStatus:
      type: string
      description: Match player status
      enum:
        - PENDING
        - PENDING_PAYMENT
        - ACCEPTED
        - REJECTED
        - LEFT
        - EXPIRED

    Match:
      type: object
      properties:
        id:
          type: string
          format: uuid
        courtId:
          type: string
          format: uuid
        hostUserId:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
          nullable: true
        images:
          type: array
          items:
            type: string
            format: uri
        skillLevel:
          $ref: '#/components/schemas/SkillLevel'
        shuttleType:
          $ref: '#/components/schemas/ShuttleType'
        playerFormat:
          $ref: '#/components/schemas/PlayerFormat'
        date:
          type: string
          format: date
        startTime:
          type: string
          example: '19:00'
        endTime:
          type: string
          example: '21:00'
        isPrivate:
          type: boolean
        price:
          type: integer
          description: Price in VND
        slotsNeeded:
          type: integer
          minimum: 1
          maximum: 10
        status:
          $ref: '#/components/schemas/MatchStatus'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    MatchPlayer:
      type: object
      properties:
        id:
          type: string
          format: uuid
        matchId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/MatchPlayerStatus'
        joinedAt:
          type: string
          format: date-time
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
            displayName:
              type: string
            avatarUrl:
              type: string
              format: uri
              nullable: true

    MatchWithDetails:
      allOf:
        - $ref: '#/components/schemas/Match'
        - type: object
          properties:
            court:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                name:
                  type: string
                addressFull:
                  type: string
                addressCity:
                  type: string
                addressDistrict:
                  type: string
            host:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                displayName:
                  type: string
                avatarUrl:
                  type: string
                  format: uri
                  nullable: true
            players:
              type: array
              items:
                $ref: '#/components/schemas/MatchPlayer'
            acceptedPlayersCount:
              type: integer

    CreateMatchRequest:
      type: object
      required:
        - courtId
        - title
        - skillLevel
        - shuttleType
        - playerFormat
        - date
        - startTime
        - endTime
        - price
        - slotsNeeded
      properties:
        courtId:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 2000
          nullable: true
        images:
          type: array
          maxItems: 10
          items:
            type: string
            format: uri
        skillLevel:
          $ref: '#/components/schemas/SkillLevel'
        shuttleType:
          $ref: '#/components/schemas/ShuttleType'
        playerFormat:
          $ref: '#/components/schemas/PlayerFormat'
        date:
          type: string
          format: date
        startTime:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
          example: '19:00'
        endTime:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
          example: '21:00'
        isPrivate:
          type: boolean
          default: false
        price:
          type: integer
          minimum: 0
          description: Price in VND
        slotsNeeded:
          type: integer
          minimum: 1
          maximum: 10

    UpdateMatchRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 2000
          nullable: true
        images:
          type: array
          maxItems: 10
          items:
            type: string
            format: uri
        skillLevel:
          $ref: '#/components/schemas/SkillLevel'
        shuttleType:
          $ref: '#/components/schemas/ShuttleType'
        playerFormat:
          $ref: '#/components/schemas/PlayerFormat'
        date:
          type: string
          format: date
        startTime:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
        endTime:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
        isPrivate:
          type: boolean
        price:
          type: integer
          minimum: 0
        slotsNeeded:
          type: integer
          minimum: 1
          maximum: 10
        status:
          $ref: '#/components/schemas/MatchStatus'

    JoinMatchRequest:
      type: object
      properties:
        message:
          type: string
          maxLength: 500
          description: Optional message to the host when requesting to join

    RespondToJoinRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum:
            - accept
            - reject

    MatchResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/MatchWithDetails'

    MatchListResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                matches:
                  type: array
                  items:
                    $ref: '#/components/schemas/MatchWithDetails'
                pagination:
                  type: object
                  properties:
                    page:
                      type: integer
                    limit:
                      type: integer
                    total:
                      type: integer
                    totalPages:
                      type: integer

    MatchPlayerResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                player:
                  $ref: '#/components/schemas/MatchPlayer'
                queuePosition:
                  type: integer
                  description: Position in the join queue (for private matches)

    # Match Payment Schemas
    MatchPaymentResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                payment:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    bookingId:
                      type: string
                      format: uuid
                      description: Match ID (for compatibility)
                    appTransId:
                      type: string
                      description: ZaloPay transaction ID
                    zpTransId:
                      type: string
                      nullable: true
                      description: ZaloPay's internal transaction ID
                    amount:
                      type: integer
                      description: Amount in VND
                    status:
                      type: string
                      enum: [pending, success, failed, expired]
                    orderUrl:
                      type: string
                      nullable: true
                      description: ZaloPay order URL
                    createdAt:
                      type: string
                      format: date-time
                    updatedAt:
                      type: string
                      format: date-time
                orderUrl:
                  type: string
                  description: ZaloPay order URL for payment
                qrCode:
                  type: object
                  properties:
                    base64:
                      type: string
                      description: Base64 encoded QR code image (data URI)
                    rawBase64:
                      type: string
                      description: Raw base64 QR code without data URI prefix
                zpTransToken:
                  type: string
                  nullable: true
                  description: Token for ZaloPay mobile SDK
                expireAt:
                  type: string
                  format: date-time
                  description: Payment expiration time
                wsSubscribeUrl:
                  type: string
                  description: WebSocket URL for payment status updates
              required:
                - payment
                - orderUrl
                - qrCode
                - expireAt
                - wsSubscribeUrl

    PaymentStatusResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                bookingId:
                  type: string
                  format: uuid
                appTransId:
                  type: string
                zpTransId:
                  type: string
                  nullable: true
                amount:
                  type: integer
                status:
                  type: string
                  enum: [pending, success, failed, expired]
                orderUrl:
                  type: string
                  nullable: true
                createdAt:
                  type: string
                  format: date-time
                updatedAt:
                  type: string
                  format: date-time

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: Firebase ID Token
      description: Firebase ID token obtained from Firebase Auth SDK

